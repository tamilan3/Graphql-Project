name: Deploy to EC2

on:
  workflow_dispatch:  # Allows manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          # Use the GitHub token to authenticate
          token: ${{ secrets.GH_TOKEN }}

      - name: Set up SSH for deployment
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          echo "$EC2_SSH_KEY" > ec2_key
          chmod 600 ec2_key

      - name: SSH and Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          set -e
          ssh -i ec2_key -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'EOF'
            # Navigate to the project directory
            cd Graphql-Project || {
              git clone https://github.com/tamilan3/Graphql-Project.git
              cd Graphql-Project
            }

            # Pull the latest code from the repository
            git pull origin master

            # Stop and remove existing containers
            docker-compose down

            # Build and start the containers using docker-compose
            docker-compose build

            docker-compose up -d
          EOF

